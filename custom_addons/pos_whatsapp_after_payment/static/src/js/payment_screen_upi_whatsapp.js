/** @odoo-module **/

import { patch } from "@web/core/utils/patch";
import { useTrackedAsync } from "@point_of_sale/app/utils/hooks";
import { PaymentScreen } from "@point_of_sale/app/screens/payment_screen/payment_screen";

const _superSetup = PaymentScreen.prototype.setup;

patch(PaymentScreen.prototype, {
    setup(...args) {
        _superSetup.call(this, ...args);
        this.sendUpiWhatsapp = useTrackedAsync(async () => {
            await this._sendUpiWhatsapp();
        });
    },

    // show only when user selected a payment line whose method is marked UPI
    get showUpiBlock() {
    // 1) find selected payment line in a reliable way
        const line =
            (this.currentOrder?.get_selected_paymentline && this.currentOrder.get_selected_paymentline()) ||
            (this.paymentLines && this.paymentLines.find((l) => l.is_selected)) ||
            (this.currentOrder?.paymentlines && this.currentOrder.paymentlines.find((l) => l.is_selected));

        // 2) resolve payment method (object or id)
        let pm = line?.payment_method || line?.payment_method_id;
        if (typeof pm === "number") {
            // try common lookups
            pm = this.pos.payment_methods_by_id?.[pm] || this.pos.payment_methods?.find((m) => m.id === pm);
        }

        console.log("[UPI] selected line:", line);
        console.log("[UPI] payment method:", pm);
        console.log("[UPI] is_upi_qr:", !!pm?.is_upi_qr);
        return !!pm?.is_upi_qr;
    },

    get upiEnabled() {
        const cfg = this.pos.config;
        return !!(cfg?.upi_payee_vpa && cfg?.upi_payee_name);
    },

    get upiUri() {
        if (!this.showUpiBlock || !this.upiEnabled) return "";
        const amount = Number(this.currentOrder.getTotalDue() || 0).toFixed(2);
        const vpa = this.pos.config.upi_payee_vpa;
        const pn = this.pos.config.upi_payee_name;
        const tn = this.currentOrder.name || ""; // optional note

        return `upi://pay?pa=${encodeURIComponent(vpa)}&pn=${encodeURIComponent(pn)}&am=${encodeURIComponent(amount)}&cu=INR&tn=${encodeURIComponent(tn)}`;
    },

    // QR image generated by Odoo itself
    get upiQrUrl() {
        if (!this.upiUri) return "";
        return `/report/barcode/?barcode_type=QR&value=${encodeURIComponent(this.upiUri)}&width=180&height=180`;
    },

    async _sendUpiWhatsapp() {
        if (!this.upiEnabled) throw new Error("UPI not configured");

        const partner = this.currentOrder.get_partner();
        const mobile = partner?.mobile || partner?.phone;
        if (!mobile) throw new Error("Customer mobile missing");

        const resp = await fetch(this.upiQrUrl, { credentials: "same-origin" });
        const blob = await resp.blob();

        const qrBase64 = await new Promise((resolve) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result.split(",")[1]);
            r.readAsDataURL(blob);
        });

        await this.pos.data.call(
            "pos.upi.whatsapp",     // âœ… NOT pos.order
            "send_upi_qr",
            [[]],
            {
                mobile,
                upi_uri: this.upiUri,
                qr_png_base64: qrBase64,
            }
        );
    },

    sendUpiOnWhatsapp() {
        console.log("[UPI] Sending UPI WhatsApp...");
        return this.sendUpiWhatsapp.call();
    },
});