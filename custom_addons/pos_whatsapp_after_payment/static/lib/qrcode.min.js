/** @odoo-module **/

import { patch } from "@web/core/utils/patch";
import { useTrackedAsync } from "@point_of_sale/app/utils/hooks";
import { PaymentScreen } from "@point_of_sale/app/screens/payment_screen/payment_screen";

// keep original setup
const _superSetup = PaymentScreen.prototype.setup;

patch(PaymentScreen.prototype, {
    setup(...args) {
        _superSetup.call(this, ...args);
        this.sendUpiWhatsapp = useTrackedAsync(this._sendUpiWhatsapp.bind(this));
    },

    get showUpiBlock() {
        const line = this.currentOrder?.selected_paymentline;
        return !!(line?.payment_method?.is_upi_qr);
    },

    get upiUri() {
        // You already said you stored payee upi id + name on pos.config.
        // Example:
        const cfg = this.pos.config;
        const upiId = cfg.upi_payee_vpa;     // e.g. "shop@okicici"
        const payeeName = cfg.upi_payee_name; // e.g. "My Store"
        const amount = this.currentOrder.getTotalDue(); // or total_with_tax
        const txnRef = this.currentOrder.name || "";

        // Minimal UPI URI
        // (amount formatting: keep 2 decimals; encode name/ref)
        const am = Number(amount || 0).toFixed(2);
        return `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${encodeURIComponent(am)}&cu=INR&tn=${encodeURIComponent(txnRef)}`;
    },

    get upiQrDataUrl() {
        if (!this.showUpiBlock) return "";
        try {
            // global QRCode lib from static/lib/qrcode.min.js
            // Many libs support toDataURL; if yours differs, adjust.
            return window.QRCode?.toDataURL
                ? window.QRCode.toDataURL(this.upiUri)
                : ""; // fallback if your lib API differs
        } catch (e) {
            return "";
        }
    },

    async _sendUpiWhatsapp() {
        const order = this.currentOrder;
        if (typeof order.id !== "number") throw new Error("Order not synced yet");

        // Send BOTH: URI + QR image
        const qrDataUrl = this.upiQrDataUrl;
        await this.pos.data.call("pos.order", "action_send_upi_payment_whatsapp", [
            [order.id],
            this.upiUri,
            qrDataUrl, // data:image/png;base64,...
        ]);
    },

    sendUpiOnWhatsapp() {
        this.sendUpiWhatsapp.call();
    },
});