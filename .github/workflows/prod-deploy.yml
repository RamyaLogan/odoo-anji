name: Deploy Odoo Prod

on: 
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ECR Image Tag to deploy (usually branch name)'
        required: true
env:
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_CLOUD_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      - name: Init Terraform
        working-directory: infra/terraform/prod
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_CLOUD_TOKEN }}
        run: terraform init

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get EC2 IP
        id: get_ip
        working-directory: infra/terraform/prod
        run: |
          RAW_OUTPUT=$(terraform output -raw odoo_server_ip 2>&1)
          SERVER_IP=$(echo "$RAW_OUTPUT" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | tail -n 1 | tr -d '\r\n')
          echo "Extracted EC2 IP: $SERVER_IP"
          echo "ec2_ip=$SERVER_IP" >> $GITHUB_ENV

      - name: Export RDS Outputs
        id: rds_outputs
        working-directory: infra/terraform/prod
        run: |
          RAW_ENDPOINT=$(terraform output -raw rds_endpoint)
          CLEAN_ENDPOINT=$(echo "$RAW_ENDPOINT" | cut -d':' -f1 | tr -d '\r\n')
          printf "rds_endpoint=%s\n" "$CLEAN_ENDPOINT" >> $GITHUB_ENV
          echo "rds_username=$(terraform output -raw rds_username)" >> $GITHUB_ENV
          echo "rds_password=$(terraform output -raw rds_password)" >> $GITHUB_ENV
          echo "rds_db_name=$(terraform output -raw rds_db_name)" >> $GITHUB_ENV
      
      - name: Debug ‚Äì Print RDS Env Vars
        run: |
          echo "üîç RDS Endpoint: $rds_endpoint"
          echo "üîç RDS Username: $rds_username"
          echo "üîç RDS DB Name:  $rds_db_name"
          echo "::add-mask::$rds_password"
          echo "‚úÖ Password is set and masked"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY_SSH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.ec2_ip }} >> ~/.ssh/known_hosts

      - name: Upload configs to EC2
        run: |
          scp -r ./docker-compose.yml ./nginx ./init-cert.sh ubuntu@${{ env.ec2_ip }}:/home/ubuntu/

      - name: Deploy to EC2
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          ECR_REPO: ${{ secrets.ECR_REPO }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-south-1
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ env.ec2_ip }} <<EOF
          set -e
          export DEBIAN_FRONTEND=noninteractive
          export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
          export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
          export AWS_REGION="${AWS_REGION}"
          export IMAGE_TAG="${IMAGE_TAG}"
          export ECR_REPO="${ECR_REPO}"
          sudo chown -R ubuntu:ubuntu .
          # Install Docker and Compose only if missing
          if ! command -v docker &> /dev/null; then
            sudo apt update && sudo apt install -y docker.io
            sudo systemctl enable docker && sudo systemctl start docker
            sudo usermod -aG docker ubuntu
          fi
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          # Ensure Docker volumes exist
          for vol in odoo_local odoo_state db_data; do
            docker volume inspect $vol >/dev/null 2>&1 || docker volume create $vol
          done
          if ! command -v aws &> /dev/null; then
            sudo apt update && sudo apt install -y unzip
            echo "Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          # Login to ECR
          aws ecr get-login-password | docker login --username AWS --password-stdin \$ECR_REPO

          cd /home/ubuntu
          cat <<EOT > .env
          ODOO_IMAGE=${ECR_REPO}:${IMAGE_TAG}
          PGHOST=${{ env.rds_endpoint }}
          PGUSER=${{ env.rds_username }}
          PGPASSWORD=${{ env.rds_password }}
          PGDATABASE=${{ env.rds_db_name }}
          EOT

          docker pull ${ECR_REPO}:${IMAGE_TAG}
          # First time certbot init (if needed)
          cp nginx/nginx-http.conf nginx/conf.d/default.conf
          docker-compose up -d nginx
          sleep 5

          
          echo "üì¶ Ensuring volumes exist"
          for vol in odoo_local odoo_state; do
            docker volume inspect \$vol >/dev/null 2>&1 || docker volume create \$vol
          done

          docker-compose ps | grep redis | grep -q Up && echo "Redis already up" || {
            echo "Starting Redis..."; docker-compose up -d redis || { docker-compose logs redis; exit 1; }
          }

          echo "‚ôªÔ∏è Restarting Odoo app containers..."
          docker-compose stop odoo odoo-runner || true
          docker-compose rm -f odoo odoo-runner || true
          docker-compose up -d odoo odoo-runner
          if [ ! -f /opt/ssl/certbot/live/mhs.doneztech.com/fullchain.pem ]; then
            echo "Bootstrapping SSL..."
            docker-compose run --rm certbot certbot certonly --webroot -w /var/www/certbot \
              -d mhs.doneztech.com --email admin@doneztech.com --agree-tos --non-interactive
            cp nginx/nginx-https.conf nginx/conf.d/default.conf
            docker-compose restart nginx
          fi
          echo "‚úÖ Deployment complete"
          EOF
