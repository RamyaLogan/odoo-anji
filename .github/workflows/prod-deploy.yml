name: Deploy Prod

on: 
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ECR Image Tag to deploy (usually branch name)'
        required: true
env:
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_CLOUD_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Init Terraform
        working-directory: infra/terraform/prod
        env:
          TF_TOKEN_app_terraform_io: ${{ secrets.TF_CLOUD_TOKEN }}
        run: terraform init

      - name: Get EC2 IP
        id: get_ip
        working-directory: infra/terraform/prod
        run: |
          RAW_OUTPUT=$(terraform output -raw odoo_server_ip 2>&1)
          SERVER_IP=$(echo "$RAW_OUTPUT" | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | tail -n 1 | tr -d '\r\n')
          echo "Extracted EC2 IP: $SERVER_IP"
          echo "ec2_ip=$SERVER_IP" >> $GITHUB_ENV

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY_SSH }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.ec2_ip }} >> ~/.ssh/known_hosts

      - name: Upload configs to EC2
        run: |
          scp -r ./docker-compose.yml ./nginx ./init-cert.sh ubuntu@${{ env.ec2_ip }}:/home/ubuntu/

      - name: Deploy to EC2
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          ECR_REPO: ${{ secrets.ECR_REPO }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-south-1
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ env.ec2_ip }} << "EOF"
          set -e
          export DEBIAN_FRONTEND=noninteractive
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_REGION="ap-south-1"
          export IMAGE_TAG=" ${{ github.event.inputs.image_tag }}"
          export ECR_REPO="${{ secrets.ECR_REPO }}"
          
          sudo chown -R ubuntu:ubuntu .
          # Install Docker and Compose only if missing
          if ! command -v docker &> /dev/null; then
            sudo apt update && sudo apt install -y docker.io
            sudo systemctl enable docker && sudo systemctl start docker
            sudo usermod -aG docker ubuntu
          fi
          if ! command -v docker-compose &> /dev/null; then
            sudo curl -SL https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
          fi

          # Ensure Docker volumes exist
          for vol in odoo_local odoo_state db_data; do
            docker volume inspect $vol >/dev/null 2>&1 || docker volume create $vol
          done
          if ! command -v aws &> /dev/null; then
            sudo apt update && sudo apt install -y unzip
            echo "Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          # Login to ECR
          aws ecr get-login-password | docker login --username AWS --password-stdin \${ECR_REPO}

          cd /home/ubuntu
          echo "ODOO_IMAGE=${ECR_REPO}:${IMAGE_TAG}" > .env

          # First time certbot init (if needed)
          cp nginx/nginx-http.conf nginx/conf.d/default.conf
          docker pull ${ECR_REPO}:${IMAGE_TAG}
          ODOO_IMAGE=${ECR_REPO}:${IMAGE_TAG}

          docker-compose up -d nginx
          sleep 5

          if [ ! -f /opt/ssl/certbot/live/mhs.doneztech.com/fullchain.pem ]; then
            echo "Bootstrapping SSL..."
            docker-compose run --rm certbot certbot certonly --webroot -w /var/www/certbot \
              -d mhs.doneztech.com --email admin@doneztech.com --agree-tos --non-interactive
            cp nginx/nginx-https.conf nginx/conf.d/default.conf
            docker-compose restart nginx
          fi


          # Start core services only if not running
          docker-compose ps | grep db | grep -q Up || docker-compose up -d db
          docker-compose ps | grep redis | grep -q Up || docker-compose up -d redis
          docker-compose ps | grep nginx | grep -q Up || docker-compose up -d nginx
          docker-compose ps | grep certbot | grep -q Up || docker-compose up -d certbot

          # Pull app image and restart app containers
          

          docker-compose stop odoo odoo-runner || true
          docker-compose rm -f odoo odoo-runner || true

          docker-compose up -d odoo odoo-runner
          EOF
